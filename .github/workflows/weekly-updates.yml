name: Weekly Slack Updates

concurrency:
  group: notify-weekly-updates
  cancel-in-progress: true

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

  schedule:
    - cron: "31 1,12 * * *"

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Setup Deno
        uses: denolib/setup-deno@v2
        with:
          deno-version: v1.30

      - name: Download indexes from last week
        run: |
          REPOS=(
            nancy.go
            frontend-reference
            devops-reference
            python-reference
          )

          # For each, extract the repository url, the branch and the file path
          # and then clone the repo, checkout the branch and get the file from
          # the last week commit.
          i=0
          for repo in "${REPOS[@]}"; do
            github_url="https://github.com/nanlabs/$repo"
            branch=main
            file_path=examples.json
            filename=examples
            extension=json
            filename="$filename-$i.$extension"
            git clone "$github_url" --branch "$branch" --single-branch --depth 1 --quiet repo-$i
            cd repo-$i
            git checkout $(git log --before="1 week ago" --format="%H" -n 1)
            cd ..
            cp "repo-$i/$file_path" "$filename"
            rm -rf "repo-$i"
            i=$((i + 1))
          done

          # Get the list of examples previously downloaded
          EXAMPLES=$(ls examples-*.json)

          # Generate the JSON file
          ./tools/readme-generator/main.ts --json examples.json $EXAMPLES > previous-week-examples.json

          # Remove the downloaded files
          rm examples-*.json

          # Log the previous week examples
          cat previous-week-examples.json

      - name: Download current indexes
        run: |
          URLS=(
            https://raw.githubusercontent.com/nanlabs/nancy.go/main/examples.json
            https://raw.githubusercontent.com/nanlabs/frontend-reference/main/examples.json
            https://raw.githubusercontent.com/nanlabs/devops-reference/main/examples.json
            https://raw.githubusercontent.com/nanlabs/python-reference/main/examples.json
          )

          # Download files preventing duplicated names (e.g. examples.json)
          i=0
          for url in "${URLS[@]}"; do
            filename=$(basename "$url")
            extension="${filename##*.}"
            filename="${filename%.*}"
            filename="$filename-$i.$extension"
            curl -s "$url" -o "$filename"
            i=$((i + 1))
          done

          # Get the list of examples previously downloaded
          EXAMPLES=$(ls examples-*.json)

          # Generate the JSON file
          ./tools/readme-generator/main.ts --json examples.json $EXAMPLES > new-examples.json

          # Remove the downloaded files
          rm examples-*.json

          # Log the new examples
          cat new-examples.json

      - name: Create a list of the new elements from the JSON!
        # Both JSON files have the following structure:
        # {
        #   "Examples": {
        #     "Category 1": {
        #       "Subcategory 1": [
        #         {
        #           name: "Example 1",
        #           description: "This is an example.",
        #           tags: ["Examples > Category 1 > Subcategory 1"],
        #           labels: ["label1", "label2"]
        #         },
        #         {
        #           name: "Example 2",
        #           description: "This is another example.",
        #           tags: ["Examples > Category 1 > Subcategory 1"],
        #           labels: ["label1", "label2"]
        #         }
        #       ]
        #     },
        #     "Category 2": {
        #       "Subcategory 2": [
        #         {
        #           name: "Example 3",
        #           description: "This is an example.",
        #           tags: ["Examples > Category 2 > Subcategory 2"],
        #           labels: ["label1", "label2"]
        #         }
        #       ]
        #     }
        #   }
        # }
        #
        # We need to list which elements are new, so we need to compare the
        # previous week JSON file with the current week JSON file. We can do
        # this with jq, which is a command-line JSON processor.
        #
        # Do it using javascript!
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const previousWeekExamples = JSON.parse(fs.readFileSync(path.join(__dirname, 'previous-week-examples.json'), 'utf8'));
            const newExamples = JSON.parse(fs.readFileSync(path.join(__dirname, 'new-examples.json'), 'utf8'));

            const previousWeekExamplesKeys = Object.keys(previousWeekExamples.Examples);
            const newExamplesKeys = Object.keys(newExamples.Examples);

            const newElements = [];

            for (const key of newExamplesKeys) {
              if (!previousWeekExamplesKeys.includes(key)) {
                newElements.push(key);
              } else {
                const previousWeekSubcategories = Object.keys(previousWeekExamples.Examples[key]);
                const newSubcategories = Object.keys(newExamples.Examples[key]);

                for (const subcategory of newSubcategories) {
                  if (!previousWeekSubcategories.includes(subcategory)) {
                    newElements.push(`${key} > ${subcategory}`);
                  } else {
                    const previousWeekExamplesInSubcategory = previousWeekExamples.Examples[key][subcategory];
                    const newExamplesInSubcategory = newExamples.Examples[key][subcategory];

                    for (const example of newExamplesInSubcategory) {
                      if (!previousWeekExamplesInSubcategory.includes(example)) {
                        newElements.push(`${key} > ${subcategory} > ${example.name}`);
                      }
                    }
                  }
                }
              }
            }

            core.setOutput('new-elements', newElements.join('\n'));
